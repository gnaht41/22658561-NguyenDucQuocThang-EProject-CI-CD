name: EProject CI/CD Workflow

# Kích hoạt workflow khi có push hoặc pull request vào nhánh 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1: Build và Test (CI)
  build_and_test:
    runs-on: ubuntu-latest # Chạy trên máy ảo Ubuntu

    # Khởi tạo các dịch vụ (database, message broker) để chạy test
    services:
      mongo:
        image: mongo:6
        ports:
          - 27017:27017
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
          - 15672:15672
        # Đợi RabbitMQ sẵn sàng
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 20

    steps:
      # Lấy code từ repo về
      - name: Checkout repository
        uses: actions/checkout@v3

      # Cài đặt Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Dùng Node 18 giống trong Dockerfile

      # Chạy test cho 'auth'
      - name: Install auth dependencies and run tests
        env:
          MONGODB_AUTH_URI: mongodb://localhost:27017/auth-test # Kết nối tới service 'mongo'
          JWT_SECRET: testsecret
        run: |
          cd auth
          npm install
          npm test

      # Chạy test cho 'product'
      - name: Install product dependencies and run tests
        env:
          MONGODB_PRODUCT_URI: mongodb://localhost:27017/product-test
          RABBITMQ_URI: amqp://localhost:5672
          JWT_SECRET: testsecret
          MONGODB_AUTH_URI: mongodb://localhost:27017/auth # Cần cho auth service
          # Lấy secret bạn đã tạo ở Bước 2
          LOGIN_TEST_USER: ${{ secrets.TEST_USER }}
          LOGIN_TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        run: |
          # Cài đặt và chạy auth service ngầm (vì test của product cần nó)
          cd auth
          npm install
          node index.js &
          cd ..
          
          # Đợi auth service sẵn sàng
          npm install -g wait-on
          wait-on http://localhost:3000

          # Cài đặt và chạy test product
          cd product
          npm install
          npm test

      # Cài đặt Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Đăng nhập Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # Lấy từ secret
          password: ${{ secrets.DOCKERHUB_TOKEN }} # Lấy từ secret

      # Build thử 4 images (chưa push)
      - name: Build (dry run) - Auth
        uses: docker/build-push-action@v4
        with:
          context: ./auth
          file: ./auth/Dockerfile
          push: false # Chỉ build, không push
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-auth:latest

      - name: Build (dry run) - Product
        uses: docker/build-push-action@v4
        with:
          context: ./product
          file: ./product/Dockerfile
          push: false
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-product:latest

      - name: Build (dry run) - Order
        uses: docker/build-push-action@v4
        with:
          context: ./order
          file: ./order/Dockerfile
          push: false
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-order:latest

      - name: Build (dry run) - API Gateway
        uses: docker/build-push-action@v4
        with:
          context: ./api-gateway
          file: ./api-gateway/Dockerfile
          push: false
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-gateway:latest

  # JOB 2: Đẩy lên Docker Hub (CD)
  push_to_docker_hub:
    # Chạy sau khi job 'build_and_test' thành công
    needs: build_and_test
    runs-on: ubuntu-latest
    # Chỉ chạy khi push lên nhánh 'main'
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build và ĐẨY (push: true) 4 images
      - name: Build and push - Auth
        uses: docker/build-push-action@v4
        with:
          context: ./auth
          file: ./auth/Dockerfile
          push: true # Đẩy image lên Docker Hub
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-auth:latest

      - name: Build and push - Product
        uses: docker/build-push-action@v4
        with:
          context: ./product
          file: ./product/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-product:latest

      - name: Build and push - Order
        uses: docker/build-push-action@v4
        with:
          context: ./order
          file: ./order/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-order:latest

      - name: Build and push - API Gateway
        uses: docker/build-push-action@v4
        with:
          context: ./api-gateway
          file: ./api-gateway/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/eproject-gateway:latest